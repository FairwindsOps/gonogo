addons:
# tests for the bundle schema validation process; should return valid
- name: metrics-server
  versions:
    start: 5.10.2
    end: 5.10.14
  notes: A text field with general notes
  source:
    chart: metrics-server
    repository: https://charts.bitnami.com/bitnami
  warnings:
  - "warning 1"
  - "warning 2"
  compatible_k8s_versions:
    max: 1.18
  necessary_api_versions:
  - apps/v1
  - core/v1
  values_schema: |
    {
      "$schema": "http://json-schema.org/schema#",
      "type": "object",
      "properties": {
        "image": {
          "type": "object",
          "required": [
            "repository",
            "pullPolicy"
            ],
            "properties": {
              "repository": {
                "type": "string",
                "pattern": "^[a-z0-9]+"
              },
              "pullPolicy": {
                "type": "string",
                "pattern": "pizza"
              }
            }
          }
        }
      }
  opa_checks:
# tests for release/bundle matching; should not be found in cluster
- name: goldilocks
  versions:
    start: 1.1.0
    end: 1.2.0
  notes: A text field with general notes
  source:
    chart: goldilocks
    repository: https://charts.fairwinds.com/stable
  warnings:
  - "warning 1"
  - "warning 2"
  compatible_k8s_versions:
    max: 1.20
    min: 1.18
  necessary_api_versions:
  - apps/v1
  - core/v1
  values_schema: ""
  opa_checks:
  - Type From the existing OPA Package
  - OPACustomCheck
  - Handle resources
# tests for locating schema files upstream
- name: apache
  versions:
    start: 8.5.11
    end: 9.0.1
  notes: A text field with general notes
  source:
    chart: apache
    repository: https://charts.bitnami.com/bitnami
  warnings:
  - "warning 1"
  - "warning 2"
  compatible_k8s_versions:
    max: 1.20
    min: 1.18
  necessary_api_versions:
  - apps/v1
  - core/v1
  values_schema: ""
  opa_checks:
# tests for no user-supplied values
- name: mysql
  versions:
    start: 8.4.2
    end: 8.8.23
  notes: A text field with general notes
  source:
    chart: mysql
    repository: https://charts.bitnami.com/bitnami
  warnings:
  - "warning 1"
  - "warning 2"
  compatible_k8s_versions:
    max: 1.20
    min: 1.18
  necessary_api_versions:
  - apps/v1
  - core/v1
  values_schema: ""
  opa_checks:
- name: nginx-ingress
  versions:
    start: 3.15.2
    end: 4.0.12
  compatible_k8s_versions:
    max: 1.22
    min: 1.19
  source:
    chart: ingress-nginx
    repository: https://kubernetes.github.io/ingress-nginx
  values_schema: ""
  opa_checks:
- name: cert-manager
  versions:
    start: 0.5.2
    end: 1.7.0
  notes: A text field with general notes
  source:
    chart: cert-manager
    repository: https://charts.jetstack.io
  warnings:
  - "warning 1"
  - "warning 2"
  compatible_k8s_versions:
    max: 1.21
    min: 1.18
  necessary_api_versions:
  - apps/v1
  - core/v1
  values_schema: ""
  resources:
  - "apps/v1/deployments"
  - "v1/pods"
  - "v1/secrets"
  opa_checks:
  - >
    package Fairwinds
    ingressUsingDeprecatedAnnotations[actionItem] {
        input.kind == "Deployment"
        input.metadata.annotations[k] = _
        startswith(k, "test")
        actionItem := {
          "title": "Deprecated annotation present",
          "description": "A deprecated or removed annotation was found",
          "severity": 0.1,
          "remediation": "Please update your ingress annotations to use the current versions. See https://cert-manager.io/docs/release-notes/release-notes-0.11/ for details",
          "category": "Reliability"
        }
      }

  - >
    package Fairwinds
    secretUsingDeprecatedAnnotations[actionItem] {
            input.kind == "Secret"
            input.metadata.annotations[k] = _
            startswith(k, "certmanager.k8s.io/")
            actionItem := {
              "title": "Deprecated annotation present",
              "description": "Old versions of the cert-manager annotation have been found on secrets",
              "severity": 0.1,
              "remediation": "Please update your secret annotations to use the current versions. See https://cert-manager.io/docs/release-notes/release-notes-0.11/ for details",
              "category": "Reliability"
            }
          }
